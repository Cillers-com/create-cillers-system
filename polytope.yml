templates:
- id: stack-rest-local 
  run:
  - couchbase
  - couchbase-init
  - redpanda
  - redpanda-init
  - redpanda-console
  - redpanda-connect
  - curity-db
  - curity
  - kong
  - web-app-react-rest
  - oauth-agent-web-app
  - api-python-rest
  - ingest-api-python
  - jupyter
  - api-client-rest
  - ingest-api-client
  - oauth-agent-api-client-rest
#  - module: ingest-api-ngrok
#    args: 
#      authtoken:  # Get your authtoken from https://dashboard.ngrok.com/get-started/your-authtoken 

- id: stack-graphql-local
  run:
  - couchbase
  - couchbase-init
  - redpanda
  - redpanda-init
  - redpanda-console
  - redpanda-connect
  - curity-db
  - curity
  - kong
  - web-app-react-graphql
  - oauth-agent-web-app
  - api-python-graphql
  - ingest-api-python
  - jupyter
  - api-client-graphql
  - ingest-api-client
  - oauth-agent-api-client-graphql
#  - module: ingest-api-ngrok
#    args: 
#      authtoken:  # Get your authtoken from https://dashboard.ngrok.com/get-started/your-authtoken 

- id: stack-graphql-vm
  params:
    - id: web-app-url
      type: [default, str, http://localhost:8080]
    - id: api-client-graphql-url
      type: [default, str, http://localhost:11001]
    - id: api-client-rest-url
      type: [default, str, http://localhost:11002]
    - id: api-protocol-host-port
      type: [default, str, http://localhost:8080]
    - id: curity-base-url
      type: [default, str, http://localhost:8443]
  run:
    - id: couchbase
      module: couchbase
    - id: couchbase-init
      module: couchbase-init
    - id: redpanda
      module: redpanda
    - id: redpanda-console
      module: redpanda-console
    - id: kafka-connect
      module: kafka-connect
    - id: create-connectors
      module: create-connectors
    - id: curity-db
      module: curity-db
    - id: curity
      module: curity
      args:
        web-app-url: "#pt-param web-app-url"
        api-client-graphql-url: "#pt-param api-client-graphql-url"
        api-client-rest-url: "#pt-param api-client-rest-url"
        curity-base-url: "#pt-param curity-base-url"
    - id: kong
      module: kong
    - id: web-app-graphql 
      module: web-app-graphql 
      args:
        api-protocol-host-port: "#pt-param api-protocol-host-port"
    - id: api-client-graphql
      module: api-client-graphql
      args:
        api-protocol-host-port: "#pt-param api-protocol-host-port"
    - id: api-client-rest
      module: api-client-rest
      args:
        api-protocol-host-port: "#pt-param api-protocol-host-port"
    - id: oauth-agent-web-app
      module: oauth-agent-web-app
      args:
        web-app-url: "#pt-param web-app-url"
        curity-base-url: "#pt-param curity-base-url"
    - id: oauth-agent-api-client-graphql
      module: oauth-agent-api-client-graphql
      args:
        api-client-graphql-url: "#pt-param api-client-graphql-url" 
        curity-base-url: "#pt-param curity-base-url" 
    - id: oauth-agent-api-client-rest
      module: oauth-agent-api-client-rest
      args:
        api-client-rest-url: "#pt-param api-client-rest-url" 
        curity-base-url: "#pt-param curity-base-rest-url" 
    - id: api-python-graphql
      module: api-python-graphql
    - id: jupyter
      module: jupyter

- id: stack-local-low-memory
  run:
    - couchbase
    - id: cb-init 
      module: couchbase-init

    - module: redpanda
      run-when:
        after: cb-init
    - id: redpanda-console
      module: redpanda-console
      run-when:
        after: cb-init
    - id: kafka-connect
      module: kafka-connect
      run-when:
        after: cb-init
    - id: create-connectors
      module: create-connectors
      run-when:
        after: cb-init

    - module: curity-db
      run-when:
        after: create-connectors 
    - module: oauth-agent-web-app
      run-when:
        after: create-connectors 
    - module: curity
      run-when:
        after: create-connectors 
    - module: kong
      run-when:
        after: create-connectors 
    - module: web-app-react-rest 
      run-when:
        after: create-connectors 
    - module: api-python-rest
      run-when:
        after: create-connectors 
    - module: jupyter
      run-when:
        after: create-connectors 
    - module: api-client-rest
      run-when:
        after: create-connectors 
    - module: oauth-agent-api-client-rest
      run-when:
        after: create-connectors 

- id: stack-local-without-redpanda
  run:
    - couchbase
    - id: cb-init 
      module: couchbase-init

    - module: curity-db
      run-when:
        after: cb-init 
    - module: oauth-agent-web-app
      run-when:
        after: cb-init 
    - module: curity
      run-when:
        after: cb-init 
    - module: kong
      run-when:
        after: cb-init 
    - module: web-app-react-rest
      run-when:
        after: cb-init 
    - module: api-python-rest
      run-when:
        after: cb-init 
    - module: jupyter
      run-when:
        after: cb-init 
    - module: api-client-rest
      run-when:
        after: cb-init 
    - module: oauth-agent-api-client-rest
      run-when:
        after: cb-init 

modules:
  - id: api-python-graphql
    info: The App API
    module: polytope/python
    params:
      - id: api-protocol-host-port 
        type: [default, str, http://localhost:11100]
    args: 
      id: api-pyton-graphql
      image: gcr.io/arched-inkwell-420116/python:3.11.8-slim-bookworm
      code: { type: host, path: ./code/api-python-graphql }
      cmd: ./bin/run
      restart: { policy: on-failure }
      services: 
      - { id: "api", ports: [{protocol: http, port: 4000}] }
      env:
        - { name: COUCHBASE_URL, value: "couchbase://couchbase" }
        - { name: COUCHBASE_USERNAME, value: admin }
        - { name: COUCHBASE_PASSWORD, value: password }
        - { name: HTTP_PORT, value: 4000 } 
        - { name: APP_PROTOCOL_HOST_PORT, value: "#pt-param api-protocol-host-port" }
        - { name: HTTP_DEBUG, value: false } 
        - { name: HTTP_AUTORELOAD, value: true } 
        - { name: HTTP_GRAPHQL_UI, value: false } 
        - { name: AUTH_OIDC_AUDIENCE, value: http://localhost/api }
        - { name: AUTH_OIDC_JWK_URL, value: http://curity:8443/oauth/v2/oauth-anonymous/jwks }
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache }}
        - { path: /root/conf/, source: { type: host, path: ./conf }}

  - id: api-python-rest
    module: polytope/python
    params:
      - { id: couchbase-protocol, type: [default, str, couchbase] }
      - { id: couchbase-host, type: [default, str, couchbase] }
      - { id: couchbase-username, type: [default, str, admin] }
      - { id: couchbase-password, type: [default, str, password] }
      - { id: couchbase-default-bucket-name, type: [default, str, main] }
      - { id: api-port, type: [default, int, 4000] }
      - { id: api-reload, type: [default, str, 'true'] }
      - { id: api-url-for-apps, type: [default, str, http://localhost:11100] }
      - { id: jwt-oidc-audience, type: [default, str, http://localhost/api] }
      - { id: jwt-oidc-jwks-url, type: [default, str, http://curity:8443/oauth/v2/oauth-anonymous/jwks] }
    args: 
      id: api-python-rest
      image: gcr.io/arched-inkwell-420116/python:3.11.8-slim-bookworm
      code: { type: host, path: ./code/api-python-rest }
      cmd: ./bin/run
      restart: { policy: on-failure }
      services: 
      - { id: "api", ports: [{protocol: http, port: "#pt-param api-port"}] }
      env:
        - { name: COUCHBASE_PROTOCOL, value: "#pt-param couchbase-protocol" }
        - { name: COUCHBASE_HOST, value: "#pt-param couchbase-host" }
        - { name: COUCHBASE_USERNAME, value: "#pt-param couchbase-username" }
        - { name: COUCHBASE_PASSWORD, value: "#pt-param couchbase-password" }
        - { name: COUCHBASE_DEFAULT_BUCKET_NAME, value: "#pt-param couchbase-default-bucket-name" }
        - { name: API_PORT, value: "#pt-param api-port" }
        - { name: API_RELOAD, value: "#pt-param api-reload" }
        - { name: API_URL_FOR_APPS, value: "#pt-param api-url-for-apps" }
        - { name: JWT_OIDC_AUDIENCE, value: "#pt-param jwt-oidc-audience" }
        - { name: JWT_OIDC_JWKS_URL, value: "#pt-param jwt-oidc-jwks-url" }
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache }}
        - { path: /root/conf/, source: { type: host, path: ./conf }}

  - id: ingest-api-python
    module: polytope/python
    params:
      - { id: api-port, type: [default, int, 4001] }
      - { id: api-reload, type: [default, str, 'true'] }
      - { id: api-url-for-apps, type: [default, str, http://localhost:4001] }
    args: 
      id: ingest-api-python
      image: gcr.io/arched-inkwell-420116/python:3.11.8-slim-bookworm
      code: { type: host, path: ./code/ingest-api-python }
      cmd: ./bin/run
      restart: { policy: on-failure }
      services: 
      - { id: "ingest-api", ports: [{protocol: http, port: "#pt-param api-port"}] }
      env:
        - { name: API_PORT, value: "#pt-param api-port" }
        - { name: API_RELOAD, value: "#pt-param api-reload" }
        - { name: API_URL_FOR_APPS, value: "#pt-param api-url-for-apps" }
        - { name: REDPANDA_BOOTSTRAP_SERVERS, value: "redpanda:9092" }
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache }}
        - { path: /root/conf/, source: { type: host, path: ./conf }}

  - id: ingest-api-ngrok
    params:
      - { id: authtoken, type: str }
    module: polytope/container
    args:
      image: ngrok/ngrok:3-alpine
      cmd: '#pt-clj (str "http --log stdout --authtoken=" (:authtoken params) " ingest-api:4001")'
      id: ingest-api-ngrok
      services: 
      - { id: "ingest-api-ngrok", ports: [{protocol: http, port: 4002}] }

  - id: jupyter
    info: "Runs a Jupyter notebook hooked up to the Cillers stack."
    module: polytope/jupyter
    args:
      services: 
      - { id: "jupyter", ports: [{protocol: http, port: 8888, expose-as: 11002}] }
      mounts:
      - path: /home/jovyan/.cache/
        source:
          type: volume
          scope: project
          id: dependency-cache
      - path: /home/jovyan/config
        source:
          path: ./conf/components/jupyter
          type: host
      - path: /home/jovyan/tutorials
        source:
          path: ./cillers/jupyter/tutorials
          type: host
      - path: /home/jovyan/work
        source:
          path: ./cillers/jupyter/work
          type: host

  - id: web-app-react-graphql
    info: The Web App
    module: polytope/node
    params:
      - id: api-protocol-host-port 
        type: [default, str, http://localhost:11100]
    args:
      id: web-app-react-graphql 
      image: gcr.io/arched-inkwell-420116/node:21.7.0-slim
      code: { type: host, path: ./code/web-app-react-graphql }
      cmd: ./bin/run
      env:
        - { name: PORT, value: 11000 } 
        - { name: HOST, value: 0.0.0.0 } 
        - { name: REACT_APP_API_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/api/graphql'" }
        - { name: REACT_APP_OAUTH_AGENT_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/oauth-agent-web-app'" }
      restart:
        policy: on-failure
      services:
        - id: web-app 
          ports: [{protocol: http, port: 11000}]
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache }}
        - { path: /root/.npm/, source: { type: volume, scope: project, id: npm-cache }} 
        - { path: /app/node_modules/, source: { type: volume, scope: project, id: npm-modules }}

  - id: web-app-react-rest
    info: The Web App
    module: polytope/node
    params:
      - id: api-protocol-host-port 
        type: [default, str, http://localhost:11100]
    args:
      id: web-app-react-rest 
      image: gcr.io/arched-inkwell-420116/node:21.7.0-slim
      code: { type: host, path: ./code/web-app-react-rest }
      cmd: ./bin/run
      env:
        - { name: PORT, value: 11000 } 
        - { name: HOST, value: 0.0.0.0 } 
        - { name: REACT_APP_API_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/api'" }
        - { name: REACT_APP_OAUTH_AGENT_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/oauth-agent-web-app'" }
      restart:
        policy: on-failure
      services:
        - id: web-app 
          ports: [{protocol: http, port: 11000}]
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache }}
        - { path: /root/.npm/, source: { type: volume, scope: project, id: npm-cache }} 
        - { path: /app/node_modules/, source: { type: volume, scope: project, id: npm-modules }}

  - id: api-client-graphql
    info: An API Client
    module: polytope/node
    params:
      - id: api-protocol-host-port
        type: [default, str, http://localhost:11100]
    args:
      id: api-client-graphql
      image: gcr.io/arched-inkwell-420116/node:21.7.0-slim
      code: { type: host, path: ./cillers/api-client-graphql }
      cmd: ./bin/run
      env:
        - { name: PORT, value: 11001 } 
        - { name: HOST, value: 0.0.0.0 } 
        - { name: REACT_APP_API_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/api/graphql'" }
        - { name: REACT_APP_OAUTH_AGENT_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/oauth-agent-api-client-graphql'" }
      restart:
        policy: on-failure
      services:
        - id: api-client-graphql
          ports: [{protocol: http, port: 11001}]
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache-api-client-graphql}}
        - { path: /root/.npm/, source: { type: volume, scope: project, id: npm-cache-api-client-graphql }} 
        - { path: /app/node_modules/, source: { type: volume, scope: project, id: npm-modules-api-client-graphql }}

  - id: api-client-rest
    info: An API Client For REST
    module: polytope/node
    params:
      - id: api-protocol-host-port
        type: [default, str, http://localhost:11100]
    args:
      id: api-client-rest
      image: gcr.io/arched-inkwell-420116/node:21.7.0-slim
      code: { type: host, path: ./cillers/api-client-rest }
      cmd: ./bin/run
      env:
        - { name: PORT, value: 11002 } 
        - { name: HOST, value: 0.0.0.0 } 
        - { name: REACT_APP_API_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/api'" }
        - { name: REACT_APP_OAUTH_AGENT_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/oauth-agent-api-client-rest'" }
      restart:
        policy: on-failure
      services:
        - id: api-client 
          ports: [{protocol: http, port: 11002}]
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache-api-client-rest }}
        - { path: /root/.npm/, source: { type: volume, scope: project, id: npm-cache-api-client-rest }} 
        - { path: /app/node_modules/, source: { type: volume, scope: project, id: npm-modules-api-client-rest }}

  - id: ingest-api-client
    info: An Ingest API Client
    module: polytope/node
    params:
      - id: api-protocol-host-port
        type: [default, str, http://localhost:4001]
    args:
      id: ingest-api-client
      image: gcr.io/arched-inkwell-420116/node:21.7.0-slim
      code: { type: host, path: ./cillers/ingest-api-client }
      cmd: ./bin/run
      env:
        - { name: PORT, value: 11003 } 
        - { name: HOST, value: 0.0.0.0 } 
        - { name: REACT_APP_API_BASE_URL, value: "#pt-js params['apiProtocolHostPort'] + '/api'" }
      restart:
        policy: on-failure
      services:
        - id: ingest-api-client 
          ports: [{protocol: http, port: 11003}]
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache-ingest-api-client}}
        - { path: /root/.npm/, source: { type: volume, scope: project, id: npm-cache-ingest-api-client}} 
        - { path: /app/node_modules/, source: { type: volume, scope: project, id: npm-modules-ingest-api-client}}

  - id: oauth-agent-web-app
    module: polytope/container
    params:
      - id: web-app-url
        type: [default, str, http://localhost:11000]
      - id: curity-base-url
        type: [default, str, http://localhost:8443]
    args: 
      id: oauth-agent-web-app
      image: gcr.io/arched-inkwell-420116/oauthagent:1.0.0 
      env:
        - { name: PORT, value: 3001 }
        - { name: TRUSTED_WEB_ORIGIN, value: "#pt-param web-app-url" }
        - { name: ISSUER, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-anonymous'" }
        - { name: AUTHORIZE_ENDPOINT, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-authorize'" }
        - { name: TOKEN_ENDPOINT, value: 'http://curity:8443/oauth/v2/oauth-token' }
        - { name: USERINFO_ENDPOINT, value: 'http://curity:8443/oauth/v2/oauth-userinfo' }
        - { name: LOGOUT_ENDPOINT, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-session/logout'" }
        - { name: CLIENT_ID, value: 'spa-client' }
        - { name: CLIENT_SECRET, value: 'Password1' }
        - { name: REDIRECT_URI, value: "#pt-js params['webAppUrl'] + '/auth/callback'" }
        - { name: POST_LOGOUT_REDIRECT_URI, value: "#pt-param web-app-url" }
        - { name: SCOPE, value: 'openid profile' }
        - { name: COOKIE_DOMAIN, value: 'localhost' }
        - { name: COOKIE_NAME_PREFIX, value: 'curity' }
        - { name: COOKIE_ENCRYPTION_KEY, value: 'fda91643fce9af565bdc34cd965b48da75d1f5bd8846bf0910dd6d7b10f06dfe' }
        - { name: CORS_ENABLED, value: 'false' }
        - { name: NODE_TLS_REJECT_UNAUTHORIZED, value: '0' }
      restart: { policy: on-failure }
      services: 
      - { id: oauth-agent-web-app, ports: [{protocol: http, port: 3001}]}

  - id: oauth-agent-api-client-graphql
    module: polytope/container
    params:
      - id: api-client-graphql-url
        type: [default, str, http://localhost:11001]
      - id: curity-base-url
        type: [default, str, http://localhost:8443]
    args: 
      id: oauth-agent-api-client-graphql
      image: gcr.io/arched-inkwell-420116/oauthagent:1.0.0 
      env:
        - { name: PORT, value: 3002 }
        - { name: TRUSTED_WEB_ORIGIN, value: "#pt-param api-client-graphql-url" }
        - { name: ISSUER, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-anonymous'" }
        - { name: AUTHORIZE_ENDPOINT, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-authorize'" }
        - { name: TOKEN_ENDPOINT, value: 'http://curity:8443/oauth/v2/oauth-token' }
        - { name: USERINFO_ENDPOINT, value: 'http://curity:8443/oauth/v2/oauth-userinfo' }
        - { name: LOGOUT_ENDPOINT, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-session/logout'" }
        - { name: CLIENT_ID, value: 'api-client-graphql' }
        - { name: CLIENT_SECRET, value: 'Password1' }
        - { name: REDIRECT_URI, value: "#pt-js params['apiClientGraphqlUrl'] + '/auth/callback'" }
        - { name: POST_LOGOUT_REDIRECT_URI, value: '#pt-param api-client-graphql-url' }
        - { name: SCOPE, value: 'openid profile' }
        - { name: COOKIE_DOMAIN, value: 'localhost' }
        - { name: COOKIE_NAME_PREFIX, value: 'curity' }
        - { name: COOKIE_ENCRYPTION_KEY, value: 'fda91643fce9af565bdc34cd965b48da75d1f5bd8846bf0910dd6d7b10f06dfe' }
        - { name: CORS_ENABLED, value: 'true' }
        - { name: NODE_TLS_REJECT_UNAUTHORIZED, value: '0' }
      restart: { policy: on-failure }
      services: 
      - { id: oauth-agent-api-client-graphql, ports: [{protocol: http, port: 3002}]}

  - id: oauth-agent-api-client-rest
    module: polytope/container
    params:
      - id: api-client-rest-url
        type: [default, str, http://localhost:11002]
      - id: curity-base-url
        type: [default, str, http://localhost:8443]
    args: 
      id: oauth-agent-api-client-rest
      image: gcr.io/arched-inkwell-420116/oauthagent:1.0.0 
      env:
        - { name: PORT, value: 3003 }
        - { name: TRUSTED_WEB_ORIGIN, value: "#pt-param api-client-rest-url" }
        - { name: ISSUER, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-anonymous'" }
        - { name: AUTHORIZE_ENDPOINT, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-authorize'" }
        - { name: TOKEN_ENDPOINT, value: 'http://curity:8443/oauth/v2/oauth-token' }
        - { name: USERINFO_ENDPOINT, value: 'http://curity:8443/oauth/v2/oauth-userinfo' }
        - { name: LOGOUT_ENDPOINT, value: "#pt-js params['curityBaseUrl'] + '/oauth/v2/oauth-session/logout'" }
        - { name: CLIENT_ID, value: 'api-client-rest' }
        - { name: CLIENT_SECRET, value: 'Password1' }
        - { name: REDIRECT_URI, value: "#pt-js params['apiClientRestUrl'] + '/auth/callback'" }
        - { name: POST_LOGOUT_REDIRECT_URI, value: '#pt-param api-client-rest-url' }
        - { name: SCOPE, value: 'openid profile' }
        - { name: COOKIE_DOMAIN, value: 'localhost' }
        - { name: COOKIE_NAME_PREFIX, value: 'curity' }
        - { name: COOKIE_ENCRYPTION_KEY, value: 'fda91643fce9af565bdc34cd965b48da75d1f5bd8846bf0910dd6d7b10f06dfe' }
        - { name: CORS_ENABLED, value: 'true' }
        - { name: NODE_TLS_REJECT_UNAUTHORIZED, value: '0' }
      restart: { policy: on-failure }
      services: 
      - { id: oauth-agent-api-client-rest, ports: [{protocol: http, port: 3003}]}

  - id: kong
    module: polytope/kong!simple
    args:
      image: gcr.io/arched-inkwell-420116/kong:3.6.1
      port: 3000
      env: 
        - { name: KONG_NGINX_HTTP_LUA_SHARED_DICT, value: 'phantom-token 10m' }
      plugins: 
        - { name: oauth-proxy, package: kong-oauth-proxy, version: 1.3.0 }
        - { name: phantom-token, package: kong-phantom-token, version: 2.0.0 }
      config-file: { type: host, path: ./conf/components/kong/dev.yml }
      autoreload: true
      services:
      - { id: kong, ports: [{ port: 3000, protocol: http, expose-as: 11100}]}

  - id: curity
    params:
    - id: curity-base-url
      type: [default, str, http://localhost:8443]
    - id: web-app-url
      type: [default, str, http://localhost:11000]
    - id: api-client-graphql-url
      type: [default, str, http://localhost:11001]   
    - id: api-client-rest-url
      type: [default, str, http://localhost:11002]   
    module: curity-base
    args:
      image: gcr.io/arched-inkwell-420116/idsvr:9.0.1
      # log-level: DEBUG  # NOTE: uncomment when developing against curity
      config-file: { type: host, path: ./conf/components/curity/config.xml }
      restart: { policy: always }
      env:
        - { name: ADMIN, value: true }
        - { name: CURITY_BASE_URL, value: "#pt-param curity-base-url" }
        - { name: WEB_APP_URL, value: "#pt-param web-app-url" }
        - { name: API_CLIENT_GRAPHQL_URL, value: "#pt-param api-client-graphql-url" }
        - { name: API_CLIENT_REST_URL, value: "#pt-param api-client-rest-url" }
      mounts:
        - { path: /opt/idsvr/usr/bin/post-commit-cli-scripts, source: { type: host, path: ./cillers/curity/post-commit-cli-scripts }}
        - { path: /opt/idsvr/etc/init/curity-users.xml, source: { type: host, path: ./conf/components/curity/users.xml }}

  - id: curity-base
    info: Runs a Curity ID server container.
    default?: true
    params:
    - id: image
      info: The container image to run.
      name: Image
      type: [default, str, 'curity.azurecr.io/curity/idsvr:9.0.1-slim']
    - id: id
      info: The ID to use for the container.
      name: ID
      type: [default, str, curity-idsvr]
    - id: cmd
      info: The command to run in the container. If unspecified, runs the ID server.
      name: Command
      type:
      - maybe
      - - either
        - str
        - - [maybe, str]
    - id: env
      info: Environment variables to pass to the server.
      name: Environment variables
      type:
      - maybe
      - [env-var]
    - id: config-file
      info: The XML config file to use.
      name: Config file
      type: [maybe, mount-source]
    - id: mounts
      info: Code or files to mount into the container.
      name: Mounts
      type:
      - maybe
      - - {source: mount-source, path: absolute-path}
    - id: restart
      info: What policy to apply on restarting containers that fail.
      name: Restart policy
      type:
      - maybe
      - policy: [enum, always, on-failure]
        max-restarts: [maybe, int]
    - id: log-level
      info: The log level for the ID server.
      name: Log level
      type: [default, str, INFO]
    module: polytope/container
    args:
      image: '#pt-clj (:image params)'
      id: '#pt-clj (:id params)'
      env: |-
        #pt-clj (concat
         [(when (:log-level params)
           {:name  "LOGGING_LEVEL"
            :value (:log-level params)})]
         (:env params))
      mounts: |-
        #pt-clj (->>
         [(when-let [f (:config-file params)]
           {:path   "/opt/idsvr/etc/init/config.xml"
            :source f})]
         (concat (:mounts params))
         (remove nil?))
      services:
      - id: curity
        ports:
        - {port: 6749, protocol: http, label: admin}
        - {port: 8443, protocol: http, label: api}
      restart: '#pt-clj (:restart params)'
      cmd: '#pt-clj (:cmd params)'

  - id: curity-db
    module: polytope/postgres
    args:
      image: gcr.io/arched-inkwell-420116/postgres:16.2
      data-volume: { type: volume, scope: project, id: curity-db-data }
      service-id: curity-db
      env:
        - { name: POSTGRES_HOST_AUTH_METHOD, value: trust }
        - { name: POSTGRES_DB, value: idsvr }
      scripts:
        - { type: host, path: ./conf/components/curity/db.sql }
      restart: { policy: on-failure }

  - id: couchbase
    module: polytope/couchbase
    args:
      image: gcr.io/arched-inkwell-420116/couchbase:enterprise-7.6.1
      data-volume: { type: volume, scope: project, id: couchbase-data }

  - id: couchbase-init
    module: polytope/python
    args:
      image: gcr.io/arched-inkwell-420116/python:3.11.8-slim-bookworm
      code: { type: host, path: ./cillers/couchbase-init }
      cmd: ./bin/run
      restart: { policy: on-failure }
      env:
        - { name: COUCHBASE_HOST, value: "couchbase" }
        - { name: COUCHBASE_TLS, value: false }
        - { name: COUCHBASE_USERNAME, value: admin }
        - { name: COUCHBASE_PASSWORD, value: password }
        - { name: COUCHBASE_MAIN_BUCKET_NAME, value: main }
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache }}
        - { path: /root/conf/, source: { type: host, path: ./conf/components/couchbase }}

  - id: redpanda
    info: Runs the Redpanda server in dev mode
    module: polytope/redpanda
    args:
      image: docker.redpanda.com/redpandadata/redpanda:v23.3.11
      root-log-level: warn 
      data-volume: { id: redpanda-data, type: volume, scope: project }

  - id: redpanda-console
    info: Runs the Redpanda Console service
    module: redpanda-console-base
    args: 
      image: docker.redpanda.com/redpandadata/console:v2.4.5
      container-id: redpanda-console
      brokers: [{host: redpanda, port: 9092}]
      log-level: info
      port: 8079
      restart: { policy: always }

  - id: redpanda-console-base
    info: Runs the Redpanda console.
    params:
    - id: image
      info: The image to use.
      name: Image
      type: [default, str, 'docker.redpanda.com/redpandadata/console:v2.4.5']
    - id: container-id
      info: The ID to give the spawned container.
      name: Container ID
      type: [default, str, redpanda-console]
    - id: brokers
      info: List of host-port pairs to use to connect to the Kafka/Redpanda cluster.
      name: Brokers
      type:
      - default
      - - {host: str, port: int}
      - - {host: redpanda, port: 9092}
    - id: schema-registry-url
      info: Schema Registry to connect to.
      name: Schema Registry URL
      type: [maybe, str]
    - id: admin-url
      info: Redpanda admin URL to connect to.
      name: Redpanda admin URL
      type: [maybe, str]
    - id: log-level
      info: The log level.
      name: Log level
      type:
      - default
      - [enum, debug, info, warn, error, fatal]
      - info
    - id: port
      info: The console HTTP port.
      name: HTTP Port
      type: [default, int, 8079]
    - id: restart
      info: Restart policy for the container.
      name: Restart policy
      type:
      - default
      - policy: [enum, always, on-failure]
        max-restarts: [maybe, int]
      - {policy: always, max-restarts: null}
    module: polytope/container
    args:
      image: '#pt-clj (:image params)'
      id: '#pt-clj (:container-id params)'
      env:
      - {name: CONFIG_FILEPATH, value: /etc/redpanda-console-config.yaml}
      mounts:
      - path: /etc/redpanda-console-config.yaml
        source:
          type: host
          path: ./conf/components/redpanda/console.yaml 
      restart: '#pt-clj (:restart params)'
      services:
      - id: redpanda-console
        ports:
        - {port: '#pt-clj (:port params)', protocol: http}

  - id: kafka-connect
    info: Runs the Kafka connect service
    module: polytope/kafka!connect
    args:
      image: gcr.io/arched-inkwell-420116/cp-kafka-connect:7.5.1
      container-id: kafka-connect-container
      connectors:
        - couchbase/kafka-connect-couchbase:4.1.13
        - confluentinc/kafka-connect-http:1.7.3
      bootstrap-servers: [{host: redpanda, port: 9092}]
      group-id: kafka-connect
      config-topic: kafka-connect-config
      config-replication-factor: 1
      offset-topic: kafka-connect-offset
      offset-replication-factor: 1
      status-topic: kafka-connect-status
      status-replication-factor: 1
      key-converter: org.apache.kafka.connect.json.JsonConverter
      value-converter: org.apache.kafka.connect.json.JsonConverter
      root-log-level: WARN
      port: 8083
      restart: { policy: always }

  - id: create-connectors
    module: polytope/kafka!create-connectors
    args:
      image: gcr.io/arched-inkwell-420116/curl:latest
      host: kafka-connect
      connectors:
        - name: couchbase-items-sink
          config:
            name:                           couchbase-items-sink
            connector.class:                com.couchbase.connect.kafka.CouchbaseSinkConnector
            tasks.max:                      '2'
            topics:                         items
            couchbase.seed.nodes:           couchbase
            couchbase.bootstrap.timeout:    10s
            couchbase.bucket:               main
            couchbase.default.collection:   _default.items
            couchbase.document.id:          ${/id}
            couchbase.username:             admin
            couchbase.password:             password
            key.converter:                  org.apache.kafka.connect.storage.StringConverter
            value.converter:                org.apache.kafka.connect.json.JsonConverter
            value.converter.schemas.enable: 'false'

  - id: polytope-redpanda-connect
    info: Runs Redpanda connect.
    params:
      - id: image
        info: The image to use.
        name: Image
        type: [default, str, docker.redpanda.com/redpandadata/connect]
      - id: container-id
        info: The ID to give the spawned container.
        name: Container ID
        type: [default, str, redpanda-connect]
      - {id: config-file, info: Redpanda connect config file., name: Config file, type: mount-source}
      - id: restart
        info: Restart policy for the container.
        name: Restart policy
        type:
        - default
        - policy: [enum, always, on-failure]
          max-restarts: [maybe, int]
        - {policy: always, max-restarts: null}
      - id: port
        info: The console HTTP port.
        name: HTTP Port
        type: [default, int, 4195]
    module: polytope/container
    args:
      image: '#pt-param image'
      id: '#pt-param container-id'
      mounts:
        - {path: /connect.yaml, source: '#pt-param config-file'}
      restart: '#pt-param restart'
      services:
        - id: redpanda-connect
          ports:
            - {port: '#pt-param port', protocol: http}

  - id: redpanda-connect
    info: Runs Redpanda Connect
    module: polytope-redpanda-connect
    args:
      config-file: { type: host, path: ./conf/components/redpanda/connect.yaml }

  - id: redpanda-init
    module: polytope/python
    args:
      image: gcr.io/arched-inkwell-420116/python:3.11.8-slim-bookworm
      code: { type: host, path: ./cillers/redpanda-init }
      cmd: ./bin/run
      restart: { policy: on-failure }
      env:
        - { name: REDPANDA_BOOTSTRAP_SERVERS, value: "redpanda:9092" }
      mounts:
        - { path: /root/.cache/, source: { type: volume, scope: project, id: dependency-cache }}
        - { path: /root/conf/, source: { type: host, path: ./conf/components/redpanda }}

